name: Release blogpost-common

on:
  push:
    branches: [ "main" ]
    paths:
      - "blogpost-common/**"

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write     # 릴리즈 생성/태그
      packages: write     # GitHub Packages 업로드

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 태그 조회/생성에 필요

      - name: MaΩke gradlew executable
        run: chmod +x blogpost-common/gradlew

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: gradle
          cache-dependency-path: |
            blogpost-common/**/*.gradle*
            blogpost-common/gradle.properties
            blogpost-common/gradle/wrapper/gradle-wrapper.properties

      - name: Read version
        id: ver
        run: |
          VERSION=$(grep -E '^version=' blogpost-common/gradle.properties | cut -d'=' -f2 | tr -d '[:space:]')
          if [ -z "$VERSION" ]; then
            echo "version not found in blogpost-common/gradle.properties" >&2
            exit 1
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Create tag & GitHub Release (if not exists)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ steps.ver.outputs.version }}
        run: |
          TAG="blogpost-common-v$VERSION"

          # 태그가 이미 있으면 릴리즈 단계만 스킵(그래도 publish는 계속)
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Tag already exists: $TAG (skip release creation)"
            exit 0
          fi

          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$TAG" -m "Release $TAG"
          git push origin "$TAG"

          gh release create "$TAG" \
            --title "$TAG" \
            --generate-notes

      - name: Publish to GitHub Packages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ./blogpost-common/gradlew -p blogpost-common publish
